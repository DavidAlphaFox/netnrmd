//netnrmd v1.0.0
//Site：https://md.netnr.com
//GitHub：https://github.com/netnr/netnrmd
//Gitee：https://gitee.com/netnr/netnrmd
//Date：2018-05-09
//Author：netnr
//Domain：https://www.netnr.com

!function(a){var b=function(a,c){return new b.fn.init(a,c)};b.fn=b.prototype={init:function(c,d){var f,e=this;return d=d||{},"function"!=typeof d.render&&(d.html=b.dv(d.html,!1),d.xhtmlOut=b.dv(d.xhtmlOut,!1),d.langPrefix=b.dv(d.langPrefix,"language-"),d.linkify=b.dv(d.linkify,!0),d.typographer=b.dv(d.typographer,!1),d.quotes=b.dv(d.quotes,"“”‘’"),d.highlight=b.dv(d.highlight,function(b,c){if(a.hljs&&hljs.getLanguage(c))try{return hljs.highlight(c,b).value}catch(d){}try{return hljs.highlightAuto(b).value}catch(d){}return""}),this.md=new Remarkable(d)),d.defer=b.dv(d.defer,500),d.prefixicon=b.dv(d.prefixicon,"fa fa-"),d.prefixkey=b.dv(d.prefixkey,"Ctrl+"),d.items=b.dv(d.items,[{title:"粗体/bold",icon:"bold",key:"B"},{title:"斜体/italic",icon:"italic",key:"I"},{title:"链接/link",icon:"link",key:"L"},{title:"引用/blockquote",icon:"quote-left",key:"Q",cmd:"quote"},{title:"标题/header",icon:"header",key:"H"},{title:"代码/code",icon:"code",key:"K"},{title:"图片/image",icon:"image",key:"G"},{title:"有序列表/ol",icon:"list-ol",key:"O"},{title:"无序列表/ul",icon:"list-ul",key:"U"},{title:"表格/table",icon:"table",key:"T"},{title:"分隔线/line",icon:"minus",key:"R",cmd:"line"},{title:"帮助/help",icon:"question",cmd:"help"},{title:"全屏/fullscreen",icon:"arrows-alt",key:"M",cmd:"full","float":"right"},{title:"分屏/splitscreen",icon:"columns",cmd:"split","float":"right"},{title:"预览/preview",icon:"eye",cmd:"preview","float":"right"}]),d.textarea=$(c).on("input",function(){return"function"==typeof d.input&&0==d.input.call(e)?!1:(e.render(),void 0)}).keydown(function(c){c=c||a.event,b.supperkey.call(this,c)}).on("keyup paste cut mouseup scroll",function(){b.syncscroll(this,100)}),d.container=d.textarea.parent(),f=[],$(d.items).each(function(){var a="right"==this.float?"float-right":"",b=this.key?d.prefixkey+this.key:"";f.push('<li class="'+a+'"><a href="#'+(this.cmd||this.icon)+'" class="'+d.prefixicon+this.icon+'" title="'+this.title+" "+b+'"></a></li>')}),d.toolbar=$('<div class="netnrmd-toolbar"><ul class="netnrmd-menu"></li></div>').children().append($(f.join(""))).click(function(c){var f,g;if(c=c||a.event,f=c.target||a.event.target,"A"==f.nodeName){if(c.preventDefault?c.preventDefault():a.event.returnValue=!1,g=f.hash.substring(1),0==e.cmdFilter(g))return!1;if(b.cmd(g,d.textarea[0],d.cmdcallback),"function"==typeof d.input&&0==d.input.call(e))return!1;e.render()}}).end(),d.write=$('<div class="netnrmd-write"></div>').append(d.textarea),d.view=$('<div class="netnrmd-view"></div>'),d.editor=$('<div class="netnrmd"></div>').append(d.toolbar).append(d.write).append(d.view),d.container.append(d.editor),this.obj=d,this.toggleFullScreen(d.fullscreen=b.dv(d.fullscreen,!1)),$(a).resize(function(){d.fullscreen&&e.height($(a).height(),!0)}),this.toggleSplitScreen(d.splitscreen=b.dv(d.splitscreen,!0)),this.togglePreview(d.preview=b.dv(d.preview,!1)),this.height(d.height=b.dv(d.height,250)),this.clear(),d.textarea.data("netnrmd",this),this},height:function(a,b){if(null!=a){if(b||!this.obj.fullscreen){!this.obj.fullscreen&&(this.obj.height=a);var c=a-this.obj.toolbar.height();this.obj.write.css("height",c),this.obj.view.css("height",c)}return this}return this.obj.height},toggleFullScreen:function(b){var c=this.obj,d=this.getToolItemTarget("full");c.fullscreen=!c.fullscreen,null!=b&&(c.fullscreen=b),c.fullscreen?(c.editor.addClass("netnrmd-fullscreen"),$(d).addClass("active"),this.height($(a).height(),!0)):(c.editor.removeClass("netnrmd-fullscreen"),$(d).removeClass("active"),this.height(c.height,!0))},toggleSplitScreen:function(a){var b=this.obj,c=this.getToolItemTarget("split");b.splitscreen=!b.splitscreen,null!=a&&(b.splitscreen=a),b.splitscreen?(b.write.removeClass("netnrmd-write-w100"),b.view.removeClass("netnrmd-view-hidden"),$(c).addClass("active")):(this.togglePreview(0),b.write.addClass("netnrmd-write-w100"),b.view.addClass("netnrmd-view-hidden"),$(c).removeClass("active"))},togglePreview:function(a){var b=this.obj,c=this.getToolItemTarget("preview");b.preview=!b.preview,null!=a&&(b.preview=a),b.preview?(this.toggleSplitScreen(1),b.write.addClass("netnrmd-write-hidden"),b.view.addClass("netnrmd-view-w100"),$(c).addClass("active")):(b.write.removeClass("netnrmd-write-hidden"),b.view.removeClass("netnrmd-view-w100"),$(c).removeClass("active"))},getToolItemTarget:function(a){var b;return this.obj.toolbar.find("a").each(function(){return this.hash=="#"+a?(b=this,!1):void 0}),b},cmdFilter:function(a){return this.obj.preview&&-1=="help,preview,split,full".indexOf(a)?!1:!0},setmd:function(a){return this.obj.textarea.val(a),this},getmd:function(){return this.obj.textarea.val()},sethtml:function(a){return this.obj.view.html(a),this},gethtml:function(){return this.obj.view.html()},clear:function(){this.setmd(""),this.sethtml('<div class="netnrmd-view-empty">预览区域</div>')},render:function(){var a=this;clearTimeout(a.deferIndex),a.deferIndex=setTimeout(function(){var b=a.getmd();""==b?a.clear():"function"==typeof a.obj.render?a.sethtml(a.obj.render(b)):a.sethtml(a.md.render(b))},a.defer)}},b.fn.init.prototype=b.fn,b.version="1.0.0",b.cmd=function(c,d,e){var f,g,h,i,j;if("function"==typeof e&&0==e.call(d,c))return!1;switch(f={cmd:c,txt:d,before:"",defaultvalue:"",after:"",newline:!1},c){case"bold":f.before="**",f.defaultvalue="粗体",f.after="**";break;case"italic":f.before="*",f.defaultvalue="斜体",f.after="*";break;case"link":f.before="[链接说明](",f.defaultvalue="https://",f.after=")";break;case"quote":f.before="> ";break;case"header":f.defaultvalue="标题",f.before="### ";break;case"code":g=d.value.substring(0,b.getCursortPosition(d)).split("\n"),""==g[g.length-1]?(f.before="```\n",f.after="\n```"):(f.before="`",f.after="`"),f.defaultvalue="输入代码";break;case"image":f.before="![图片说明](",f.defaultvalue="https://",f.after=")";break;case"list-ol":f.before="1. ",f.defaultvalue="列表文本";break;case"list-ul":f.before="- ",f.defaultvalue="列表文本";break;case"table":h=" col 1 | col 2 | col 3 ",i=" ---- | ---- | ---- ",j="\r\n",f.before=h+j+i+j+h+j+h+j;break;case"line":f.before="----------\r\n",b.getCursortPosition(d)&&(f.before="\r\n\r\n"+f.before);break;case"help":a.open("https://netnr.gitee.io/markdownguide/","_blank");break;case"full":$(d).data("netnrmd").toggleFullScreen();break;case"preview":$(d).data("netnrmd").togglePreview();break;case"split":$(d).data("netnrmd").toggleSplitScreen()}b.insertxt(f)},b.dv=function(a,b){return null==a||void 0==a?b:a},b.getCursortPosition=function(a){var c,b=0;return document.selection?(a.focus(),c=document.selection.createRange(),c.moveStart("character",-a.value.length),b=c.text.length):(a.selectionStart||"0"==a.selectionStart)&&(b=a.selectionStart),b},b.setCaretPosition=function(a,b){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}},b.getSelectText=function(b){var c="";return b.selectionStart||"0"==b.selectionStart?c=b.value.substring(b.selectionStart,b.selectionEnd):a.getSelection?c=a.getSelection():document.selection&&(c=document.selection.createRange().text),c},b.setSelectText=function(a,b,c){var d,e;b=parseInt(b),c=parseInt(c),d=a.value.length,d&&(b||(b=0),c||(c=d),b>d&&(b=d),c>d&&(c=d),a.createTextRange?(e=a.createTextRange(),e.moveStart("character",b),e.moveEnd("character",c-b),e.select()):(a.setSelectionRange(b,c),a.focus()))},b.insertAfterText=function(a,b){var c,d,e,f;document.selection?(a.focus(),c=document.selection.createRange(),c.text=b,a.focus()):a.selectionStart||"0"==a.selectionStart?(d=a.selectionStart,e=a.selectionEnd,f=a.scrollTop,a.value=a.value.substring(0,d)+b+a.value.substring(e,a.value.length),a.focus(),a.selectionStart=d+b.length,a.selectionEnd=d+b.length,a.scrollTop=f):(a.value+=b,a.focus())},b.insertxt=function(a){var c,d,e,f,g,h;a.cmd&&""!=a.cmd&&(c=a.txt,d=a.before,e=a.defaultvalue,f=a.after,g=b.getSelectText(c),h=b.getCursortPosition(c)+d.length,""==g.trim()&&(g=e),b.insertAfterText(c,d+g+f),b.setSelectText(c,h,h+g.length))},b.syncscroll=function(a,b){clearTimeout(a.syncdefer),a.syncdefer=setTimeout(function(){var c=$(a).data("netnrmd").obj,d=a.scrollTop/(a.scrollHeight-$(a).height());c.view.animate({scrollTop:c.view[0].scrollHeight*d},b)},b)},b.supperkey=function(c){var e,f,g,h,i,j,k,l,m,n,o,d=c.keyCode||c.which||c.charCode;9==d?this.selectionStart||"0"==this.selectionStart?(c.preventDefault(),e=this.selectionStart,f=this.selectionEnd,g=this.value,h="　　",g=g.substr(0,e)+h+g.substr(e),this.value=g,this.selectionStart=e+h.length,this.selectionEnd=f+h.length):(j=event.srcElement.document.selection.createRange(),l=event.srcElement.createTextRange(),event.returnValue=!1,j.getClientRects().length>1?(i=j.text,k=j.duplicate(),k.moveToPoint(l.getBoundingClientRect().left,j.getClientRects()[0].top),j.setEndPoint("startToStart",k),j.text="　　"+j.text.replace(/\r\n/g,"\r	"),i=i.replace(/\r\n/g,"\r	"),l.findText(i),l.select()):(j.text="　　",j.select())):c.ctrlKey&&(m=$(this).data("netnrmd"),n=m.obj,o=String.fromCharCode(d).toUpperCase(),""!=o&&$(n.items).each(function(){if(this.key==o){console.log(this.key),c.preventDefault?c.preventDefault():a.event.returnValue=!1;var d=this.cmd||this.icon;return 0==m.cmdFilter(d)?!1:(b.cmd(d,n.textarea[0],n.cmdcallback),"function"==typeof n.input&&0==n.input.call(m)?!1:(m.render(),!1))}}))},a.netnrmd=b}(window);